@page "/gameoflife"
@using System.Net.Http.Json
@using System.Linq
@inject HttpClient Http

<h3>Game of Life</h3>

@if(isShowDatabase){
    <h4>Saved Patterns</h4>
    <button class="btn btn-primary" @onclick="() => isShowDatabase = false">Back to game</button>
    <button class="btn btn-primary" @onclick="AddPattern">Save pattern</button>
    
    <div class="list-group">
        @foreach (var item in database)
        {
            <div class="list-group-item d-flex justify-content-between">
                <span>@item.Name</span>
                <button class="btn btn-primary" @onclick="() => LoadPattern(item)">Load @item.Name</button>
            </div>
        }
    </div>
}
else
{
    @if (grid == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="grid-container" style="--cols: @grid[0].Length">
            @for (int i = 0; i < grid.Length; i++)
            {
                @for (int j = 0; j < grid[i].Length; j++)
                {
                    <div class="cell @(grid[i][j] ? "alive" : "dead")"></div>
                }
            }
        </div>

        <button class="btn btn-primary" @onclick="LoadNext">Next generation</button>
        @if(isAutoRunning){
            <button class="btn btn-primary" @onclick="() => isAutoRunning = false">Stop auto</button>
        }
        else{
            <button class="btn btn-primary" @onclick="ToggleAuto">Toggle auto</button>
        }
    }
}
@if(!isShowDatabase){
    <button class="btn btn-primary" @onclick="GetDatabase">Show database</button>
}

@code {
    public class GamePattern
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Data { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
    }
    private bool[][]? grid;
    private List<GamePattern> database = [];
    private bool isAutoRunning = false;
    private bool isShowDatabase = false;

    protected override async Task OnInitializedAsync()
    {
        grid = await Http.GetFromJsonAsync<bool[][]>("api/game/state");
    }

    private async Task LoadNext()
    {
        grid = await Http.GetFromJsonAsync<bool[][]>("api/game/next");
    }

    private async Task ToggleAuto()
    {
        if(isAutoRunning) return;
        isAutoRunning = true;

        while(isAutoRunning){
            await LoadNext();
            StateHasChanged();
            await Task.Delay(200);
        }
    }

    private async Task GetDatabase()
    {
        isShowDatabase = true;
        var result = await Http.GetFromJsonAsync<List<GamePattern>>("api/patterns");
        if (result != null)
        {
            database = result;
        }
    }

    private async Task AddPattern(){
        var NewPattern = new GamePattern { Name = "My Pattern " + DateTime.Now.ToShortTimeString(), Data = JsonSerializer.Serialize(grid)};
        await Http.PostAsJsonAsync("api/patterns", NewPattern);
        await GetDatabase();
    }

    private async Task LoadPattern(GamePattern selectedGrid)
    {
        await Http.PostAsJsonAsync("api/game/state", selectedGrid);
    }
}
